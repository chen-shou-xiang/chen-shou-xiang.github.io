import{_ as r,c as d,b as n,d as i,e as a,a as t,w as l,r as h,o as g}from"./app-CZNADAVY.js";const y="/assets/LifeCycleOfClass-CukdcOeI.png",o="/assets/classLifecycle-load-H3ldorKE.png",A="/assets/extAndAppClassLoaderExtend-y2BiE3Ne.png",c="/assets/ParentDelegationModel-CrLa8v2v.png",D={},u={class:"hint-container details"},B={class:"hint-container details"},m={class:"hint-container details"},C={class:"hint-container details"},E={class:"code-block-title"},v={class:"code-block-title-bar"},f={class:"title"},b={class:"hint-container details"};function x(S,s){const k=h("Abbreviation"),p=h("Annotation"),e=h("VPIcon");return g(),d("div",null,[s[50]||(s[50]=n('<h3 id="_1-类的生命周期" tabindex="-1"><a class="header-anchor" href="#_1-类的生命周期"><span>1. 类的生命周期</span></a></h3><p>类的生命周期描述了一个类加载、使用、卸载的整个过程： <img src="'+y+'" alt="alt text"></p><h4 id="_1-加载" tabindex="-1"><a class="header-anchor" href="#_1-加载"><span>(1) 加载</span></a></h4><p>类加载器将字节码信息（.class 文件、动态代理生成或网络传输的字节码）加载到方法区中；</p><ul><li>创建 <code>InstanceKlass</code> 对象，保存类的所有信息（基本信息、常量池等）；</li><li>同时在堆中生成一份与方法区中数据类似的<code>java.lang.Class</code>对象。</li></ul><details class="hint-container details"><summary>图示</summary><p><img src="'+o+'" alt="alt text"></p></details><h4 id="_2-链接" tabindex="-1"><a class="header-anchor" href="#_2-链接"><span>(2) 链接</span></a></h4><ul><li>验证：检查字节码是否符合虚拟机规范；</li><li>准备：为静态变量分配内存并设置默认值（<code>final修饰的常量</code> 变量则直接赋值）；</li><li>解析：将常量池中的符号引用转为直接引用(内存地址)。</li></ul><h4 id="_3-初始化" tabindex="-1"><a class="header-anchor" href="#_3-初始化"><span>(3) 初始化</span></a></h4><p>行静态代码块中的代码，并为静态变量赋值。（即执行<code>clinit</code>方法）</p><details class="hint-container details"><summary>以下情况类没有 clinit 方法</summary><ul><li>无静态代码块且无静态变量赋值语句;</li><li>有静态变量的声明，但是<code>没有赋值语句</code>;</li><li>静态变量时 <code>final 修饰的常量</code>，这类变量会在准备阶段直接进行初始化。</li></ul></details><details class="hint-container details"><summary>触发类加载的情况</summary><ol><li>执行 Main 方法的当前类；</li><li>首次访问静态变量或静态方法；</li><li>Class.forName(&quot;类名&quot;)；</li><li>new 当前类创建对象；</li><li>子类初始化时，若父类还未初始化则先触发（但通过子类访问父类的静态变量只会触发父类初始化）；</li></ol></details><details class="hint-container details"><summary>不会触发类加载的情况</summary><ol><li>访问 final 常量；</li><li>创建该类数组；</li><li>Class.forName(&quot;类名&quot;, false, ...) 第二个参数为 false。</li></ol></details><h3 id="_2-类加载器" tabindex="-1"><a class="header-anchor" href="#_2-类加载器"><span>2. 类加载器</span></a></h3><p>类加载器（ClassLoader）用于获取字节码并将其加载到内存中。</p><h4 id="_2-1-类加载器分类" tabindex="-1"><a class="header-anchor" href="#_2-1-类加载器分类"><span>2.1 <strong>类加载器分类</strong></span></a></h4><p>(1). <mark>启动类加载器（BootstrapClassLoader）</mark>：用于加载 JDK 自带的核心类库。</p>',17)),i("details",u,[s[9]||(s[9]=i("summary",null,"JDK8 以及 JDK9 之后的启动类加载器",-1)),s[10]||(s[10]=i("p",null,"在 JDK8 中：",-1)),s[11]||(s[11]=i("ul",null,[i("li",null,[a("加载 "),i("code",null,"JAVA_HOME/jre/lib"),a(" 目录下的类库文件，此目录下包括 rt.jar，tools.jar，resources.jar 等，其中 java.lang、java.util、java.io 等核心包就位于 rt.jar 中；")]),i("li",null,[a("由虚拟机自身实现（一般是 C++），无法获取其引用。（"),i("code",null,"String.class.getClassLoader() 返回 null "),a("）；")])],-1)),s[12]||(s[12]=i("p",null,"在 JDK9 及之后：",-1)),i("ul",null,[i("li",null,[s[2]||(s[2]=a("引入 ")),t(k,{"aria-label":"模块化系统不在本章的讨论范围。"},{tooltip:l(()=>s[0]||(s[0]=[a("模块化系统不在本章的讨论范围。")])),default:l(()=>[s[1]||(s[1]=a("模块化系统"))]),_:1}),s[3]||(s[3]=a(" ，移除 ")),s[4]||(s[4]=i("code",null,"JAVA_HOME/jre",-1)),s[5]||(s[5]=a(" 目录，核心类库存放到 ")),s[6]||(s[6]=i("code",null,"jmod后缀",-1)),s[7]||(s[7]=a(" 的文件中；"))]),s[8]||(s[8]=i("li",null,"部分逻辑由Java代码实现，但同样无法获取其引用。",-1))])]),s[51]||(s[51]=i("p",null,[a("(2). "),i("mark",null,"扩展类加载器 (ExtClassLoader)"),a("：用于加载非核心的扩展类库（插件）。")],-1)),i("details",B,[s[21]||(s[21]=i("summary",null,"JDK8 以及 JDK9 之后的扩展类加载器",-1)),s[22]||(s[22]=i("p",null,"在 JDK8 中：",-1)),s[23]||(s[23]=i("ul",null,[i("li",null,[a("加载 "),i("code",null,"JAVA_HOME/jre/lib/ext"),a(" 目录下的类库文件;")]),i("li",null,[a("继承链： "),i("img",{src:A,alt:"alt text"})])],-1)),s[24]||(s[24]=i("p",null,"在 JDK9 及之后：",-1)),i("ul",null,[i("li",null,[s[15]||(s[15]=a("引入 ")),t(k,{"aria-label":"模块化系统不在本章的讨论范围。"},{tooltip:l(()=>s[13]||(s[13]=[a("模块化系统不在本章的讨论范围。")])),default:l(()=>[s[14]||(s[14]=a("模块化系统"))]),_:1}),s[16]||(s[16]=a(" ，")),s[17]||(s[17]=i("code",null,"ExtClassLoader",-1)),s[18]||(s[18]=a(" 被重命名为 ")),s[19]||(s[19]=i("code",null,"PlatformClassLoader",-1)),s[20]||(s[20]=a("，其职责不再去加载特定目录，而是会去加载一些特定模块（java.xml等）。"))])])]),s[52]||(s[52]=n(`<p>(3). <mark>系统类加载器 (AppClassLoader)</mark>：用于加载<code>classpath</code>中的相关类库。</p><details class="hint-container details"><summary>classpath最终确定算法</summary><ul><li>若通过指定了<code>-cp</code>或<code>-classpath</code>vm参数，则优先使用指定的参数（可指定多个路径）；</li><li>若没有指定vm参数，则使用<code>CLASSPATH</code>环境变量（一般不推荐设置）。</li><li>若没有<code>ClASSPATH</code>环境变量，则使用当前目录（.）。</li></ul><p>示例：</p><div class="language-text" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>/home/user/</span></span>
<span class="line"><span>|—— myapp/</span></span>
<span class="line"><span>│   └── MyApp.class</span></span>
<span class="line"><span>└── lib/</span></span>
<span class="line"><span>    └── utils.class</span></span></code></pre></div><p>其中MyApp类中使用到utils中的工具类，且没有设置package包名，系统没有ClASSPATH环境变量；此时进入 <code>/home/user/myapp</code> 运行此类:</p><ul><li>未指定vm参数，报错：ClassNotFoundException，找不到Utils中的类；</li><li>指定vm参数 <code>-cp &quot;../lib&quot;</code>, 报错：ClassNotFoundException，MyApp找不到；</li><li>添加vm参数 <code>-cp &quot;../lib/;.&quot;</code>（lib目录和当前目录） 或 <code>-cp &quot;../&quot;</code>（user目录）, 运行成功。</li></ul></details><div class="hint-container tip"><p class="hint-container-title">JDK9+中可以使用<code>--module-path</code>参数指定模块路径来加载指定模块中的类。</p></div><h4 id="_2-2-获取当前类加载器的方式" tabindex="-1"><a class="header-anchor" href="#_2-2-获取当前类加载器的方式"><span>2.2 <strong>获取当前类加载器的方式</strong></span></a></h4><div class="language-java" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> MyApp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[]</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 方式一：</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        ClassLoader</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cl1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> MyApp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">class</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getClassLoader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 方式二：</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        ClassLoader</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cl2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getClassLoader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 方式三：</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        ClassLoader</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cl3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">currentThread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getContextClassLoader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span></code></pre></div><h4 id="_2-3-使用指定类加载器加载指定类库" tabindex="-1"><a class="header-anchor" href="#_2-3-使用指定类加载器加载指定类库"><span>2.3 <strong>使用指定类加载器加载指定类库</strong></span></a></h4>`,6)),i("details",m,[s[37]||(s[37]=i("summary",null,"JDK8中通过文件路径的方式",-1)),i("ul",null,[i("li",null,[s[28]||(s[28]=i("p",null,"BootstrapClassLoader:",-1)),i("ul",null,[s[27]||(s[27]=i("li",null,[a("使用 JVM 参数进行扩展: "),i("code",null,"-Xbootclasspath/a:jar包目录/jar包名")],-1)),i("li",null,[s[26]||(s[26]=a("放入 jre/lib 下进行扩展 ")),t(p,{label:"extUserClass",total:1},{"item-0":l(()=>s[25]||(s[25]=[i("p",null,"不推荐，尽可能不要去更改 JDK 安装目录中的内容，会出现即使放进去由于文件名不匹配的问题也不会正常地被加载。",-1)])),_:1})])])]),i("li",null,[s[35]||(s[35]=i("p",null,"ExtClassLoader:",-1)),i("ul",null,[i("li",null,[s[30]||(s[30]=a("使用 JVM 参数进行扩展: ")),s[31]||(s[31]=i("code",null,"-Djava.ext.dirs=jar包目录",-1)),s[32]||(s[32]=a()),t(p,{label:"jvmExtUserClass",total:1},{"item-0":l(()=>s[29]||(s[29]=[i("p",null,[a("推荐，使用进行扩展,这种方式会覆盖掉原始目录，可以用"),i("code",null,";(windows):(macos/linux)"),a("追加上原始目录。")],-1)])),_:1})]),i("li",null,[s[34]||(s[34]=a("放入 /jre/lib/ext 下进行扩展; ")),t(p,{label:"extUserClass2",total:1},{"item-0":l(()=>s[33]||(s[33]=[i("p",null,"不推荐，尽可能不要去更改JDK安装目录中的内容。",-1)])),_:1})])])]),s[36]||(s[36]=n("<li><p>AppClassLoader:</p><ul><li>vm参数: <code>-cp</code> 或 <code>-classpath</code> （优先级最高）；</li><li><code>CLASSPATH</code> （优先级次之）；</li><li><code>.</code> 默认当前运行目录。</li></ul></li>",1))])]),s[53]||(s[53]=n('<details class="hint-container details"><summary>通过代码的方式</summary><ul><li>使用<code>Class.forName</code>方法，使用当前类的类加载器去加载指定的类；</li><li>获取到类加载器，通过类加载器的loadClass方法指定某个类加载器加载。</li></ul><blockquote><p>注意：无法通过代码方式使用启动类加载器加载指定类，因为无法获取到启动类加载器实例对象。</p></blockquote></details><h3 id="_3-双亲委派机制" tabindex="-1"><a class="header-anchor" href="#_3-双亲委派机制"><span>3. 双亲委派机制</span></a></h3><p><strong>定义</strong>：自底向上查找是否加载过，再由顶向下进行加载。 <img src="'+c+'" alt="alt text"></p><p><strong>作用</strong>：</p><ul><li><code>避免重复加载</code>：在双亲委派算法中，一个类只会加载一次，保证了类的全局唯一性。</li><li><code>安全性</code>：防止核心Java API（如java.lang.Object）被用户自定义的类所篡改，因为核心API最终会委派给启动类加载器进行加载；</li></ul>',5)),i("details",C,[s[40]||(s[40]=i("summary",null,"双亲委派机制算法源码",-1)),i("div",E,[i("div",v,[i("span",f,[t(e,{name:"vscode-icons:file-type-java"}),s[38]||(s[38]=a("ClassLoader.java"))])]),s[39]||(s[39]=n(`<div class="language-java" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 这里是简易版，完整版请查阅源码</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">protected</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Class</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">?</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> loadClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> boolean</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    throws ClassNotFoundException</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    synchronized</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getClassLoadingLock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 第一步：检查这个类是否已经被当前加载器加载过了</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        Class</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> c</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> findLoadedClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">c </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                // 第二步：如果父加载器不为空，就委派给父加载器去加载</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">parent </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                    c </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> parent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">loadClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 递归调用</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                    // 如果父加载器为空（说明是Bootstrap加载器），则调用本地方法委派给它</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                    c </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> findBootstrapClassOrNull</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ClassNotFoundException </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                // 父加载器无法完成加载，抛出ClassNotFoundException异常，我们将捕获它，但不做任何处理</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                // 这是为了进入第三步：自己尝试加载</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            // 第三步：如果父加载器（包括Bootstrap）都没找到，才调用自己的findClass方法</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">c </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                c </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> findClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 如果指定要解析，则进行链接阶段的解析操作</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            resolveClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">c</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div>`,1))]),s[41]||(s[41]=i("blockquote",null,[i("p",null,"findClass() 方法通常是由 ClassLoader 的子类重写的，用于定义自己特定的类加载逻辑（例如，从网络、字节码文件、数据库中加载）。而 loadClass() 方法实现了双亲委派的算法框架，一般不建议重写它。")],-1))]),s[54]||(s[54]=n('<h3 id="_4-打破双亲委派机制" tabindex="-1"><a class="header-anchor" href="#_4-打破双亲委派机制"><span>4. 打破双亲委派机制</span></a></h3><p>(1) <strong>自定义类加载器</strong></p><p>继承 <code>ClassLoader</code> 抽象类，重写<code>loadClass</code>方法。</p><details class="hint-container details"><summary>示例：Tomcat 服务器支持部署多个 war 包（Servlet 应用）</summary><p>Tomcat 支持部署多个 war 包，例如配置<code>上下文路径</code>模式:</p><p>工作原理：</p><p>1.你将你的 Web 应用打包成 WAR 文件，例如 wiki.war 和 blog.war。</p><p>2.你把这两个文件放到 Tomcat 的 webapps 目录下。</p><p>3.Tomcat 会自动解压并部署它们。默认情况下，WAR 文件的名字就是应用的上下文路径。</p><p>访问示例：</p><p>•要访问 wiki 应用，你的 URL 是：http://yourdomain.com:8080/wiki</p><p>•要访问 blog 应用，你的 URL 是：http://yourdomain.com:8080/blog</p><p>以上实现基于 Tomcat 的自定义类加载器，他可以为每一个 war 包创建一个单独的类加载器实例去加载各自 war 包中的类，以实现一个 JVM 部署多个 Servlet 应用。</p><p>具体配置方式以及类加载器原理，请查阅 Tomcat 文档或问 AI。</p></details><p>(2) <strong>SPI机制 + 线程上下文类加载器</strong></p><p><mark class="important">SPI 机制</mark> ：通过 <code>约定</code> + <code>反射机制</code> 获取第三方提供的接口实现类的机制；</p><p><mark class="important">线程上下文类加载器</mark>：默认为<code>ApplicationClassLoader</code>, 可以通过<code>setContextClassLoader</code>方法设置。</p><div class="hint-container important"><p class="hint-container-title">为什么SPI机制 + TCCL 可以打破双亲委派机制？</p><p>按照双亲委派机制，<code>启动类加载器</code>和<code>扩展类加载器</code>只能加载自身负责的类，但在这部分类中，可以通过获取 TCCL 去加载不属于其职责范围内的类，如classpath中的类，而这部分类可以由SPI机制<strong>动态</strong>获取到。正是因为此TCCL机制和SPI机制的设计，从而打破了双亲委派机制。</p><p>如 java.lang.DriverManager，其内部通过 TCCL 加载了 classpath 中的第三方 jar 包提供的 Driver 实现，也就是启动类加载器委派应用类加载器去加载类，具体可以看以下 JDBC 示例。</p></div>',8)),i("details",b,[s[48]||(s[48]=n(`<summary>SPI 机制原理</summary><ul><li><strong>核心思想</strong>：解耦与可扩展性。程序核心逻辑只面向接口编程，具体实现由第三方提供，并可动态替换。</li><li><strong>实现原理</strong>： <ol><li><strong>基于约定</strong>：服务提供方必须在 JAR 包的 <code>META-INF/services/</code> 目录下（或 classpath 根目录下），创建以<strong>接口全限定名</strong>命名的配置文件，并在文件内填写<strong>实现类的全限定名</strong>。</li><li><strong>基于反射</strong>：程序通过 <code>java.util.ServiceLoader</code> 类扫描 Classpath，找到所有符合约定的配置文件，并利用<strong>反射机制</strong>动态加载并实例化这些实现类。</li></ol></li><li>标准的 SPI 架构： <ul><li><code>服务接口定义方 (API/SPI Jar)</code>：一个独立的、轻量级的 JAR 包，例如 payment-api.jar。它只包含服务接口，比如我们的 PayService 接口。它不包含任何具体的实现。它的唯一目的就是定义一个“契约”。</li><li><code>服务实现提供方 (Provider Jar)</code>：第三方开发者（或您自己团队的另一个模块）创建的 JAR 包，例如 alipay-provider.jar 或 wechatpay-provider.jar。这个提供方的项目，必须依赖于第一步中的 payment-api.jar。这样，它才能导入此接口并提供自身实现（如 Alipay）。</li><li><code>服务使用方 (Consumer Application)</code>：需要使用支付功能的应用程序，它也必须依赖于 payment-api.jar，这样它才能通过接口 PayService 来编码，并调用 ServiceLoader.load(PayService.class)。这个应用程序在编译时完全不知道 Alipay 或 WechatPay 类的存在，它只知道 PayService 接口，在运行时，只需要将它想使用的提供方 JAR（如 alipay-provider.jar）放到它的类路径下。</li></ul></li></ul><p>支付示例：</p><p>maven 项目依赖结构：</p><div class="language-text" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>                    +-----------------------------+</span></span>
<span class="line"><span>                    |          spi-consumer       |</span></span>
<span class="line"><span>                    |           (服务消费者)        |</span></span>
<span class="line"><span>                    +-----------------------------+</span></span>
<span class="line"><span>                      /             |            \\</span></span>
<span class="line"><span>                     /              |             \\</span></span>
<span class="line"><span>                    /               |              \\</span></span>
<span class="line"><span>                   /                |               \\</span></span>
<span class="line"><span>                  v                 v                v</span></span>
<span class="line"><span>+----------------+         +----------------+         +------------------+</span></span>
<span class="line"><span>|   spi-alipay   |         |    spi-api     |         |  spi-wechatPay   |</span></span>
<span class="line"><span>| （ 服务提供者 )  |-------&gt; |    (服务接口)    | &lt;------|   （服务提供者）    |</span></span>
<span class="line"><span>|                |         |                |         |                  |</span></span>
<span class="line"><span>+----------------+         +----------------+         +------------------+</span></span></code></pre></div>`,5)),i("ul",null,[s[47]||(s[47]=n(`<li><p>spi 服务接口定义方（spi-api）：</p><div class="language-java" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">package</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">api</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> interface</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> PayService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> pay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div></li><li><p>spi 服务实现提供方（以 spi-Alipay 为例）：</p><p>（1）实现接口</p><div class="language-java" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">package</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">alibaba</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">api</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PayService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Alipay</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> implements</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> PayService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Override</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> pay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        System</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">out</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">println</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">this is alipay</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><p>（2）在<code>resource</code>目录中创建<code>META-INF/servicers/com.api.PayService</code>，内容为实现类全限定名：</p><div class="language-text" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>com.alibaba.Alipay</span></span></code></pre></div></li>`,2)),i("li",null,[s[45]||(s[45]=n(`<p>服务使用方（spi-consumer）：</p><div class="language-java" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">package</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">summer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">api</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PayService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> java</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">util</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ServiceLoader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> App</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[]</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        ServiceLoader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">PayService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> payServices</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ServiceLoader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">load</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">PayService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">class</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PayService</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> payService</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> payServices</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            payService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><p>测试引入 alipay 和 wechatPay 包的效果，如果两个都引入，则打印：</p><div class="language-text" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>this is alipay</span></span>
<span class="line"><span>wechatPay is running</span></span></code></pre></div>`,4)),i("p",null,[s[43]||(s[43]=a("如果通过 java -jar 运行，则需要配置打包 Fat JAR ")),t(p,{label:"farjar",total:1},{"item-0":l(()=>s[42]||(s[42]=[i("p",null,'将项目自身代码和所有依赖的第三方库一起打包到一个单独的 JAR 文件中，这就被称为 "Fat JAR"（胖 JAR 包）或者 "Uber JAR"。',-1)])),_:1}),s[44]||(s[44]=a(" 的插件："))]),s[46]||(s[46]=n(`<div class="language-xml" data-highlighter="shiki" data-ext="xml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">build</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">plugins</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        &lt;!-- 这里以shade插件为例，此插件会将依赖包一起打包--&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">plugin</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">groupId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">org.apache.maven.plugins</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">groupId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">artifactId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">maven-shade-plugin</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">artifactId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">3.5.1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">executions</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">execution</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                    &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">phase</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">package</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">phase</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                    &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">goals</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                        &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">goal</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">shade</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">goal</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                    &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">goals</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                    &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">configuration</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                        &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">transformers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                            &lt;!-- 此transformer指定启动类--&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                            &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">transformer</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> implementation</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">org.apache.maven.plugins.shade.resource.ManifestResourceTransformer</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                                &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">mainClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">com.summer.App</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">mainClass</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                            &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">transformer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                            &lt;!-- 此transformer会将依赖包的META-INF/services/目录下的SPI实现类文件合并 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                            &lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">transformer</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> implementation</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">org.apache.maven.plugins.shade.resource.ServicesResourceTransformer</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                        &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">transformers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                    &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">configuration</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">execution</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">executions</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">plugin</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">plugins</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">build</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span></code></pre></div>`,1))])]),s[49]||(s[49]=i("p",null,"需要注意到是，以上SPI示例并没有打破双亲委派机制，因为服务接口定义方、服务实现提供方、服务使用方都位于classpath中，都由AppClassLoader加载。",-1))]),s[55]||(s[55]=n(`<details class="hint-container details"><summary>JDBC 示例</summary><p>JDBC 的实现方式与上方的简单示例类似：</p><ul><li><p>spi 服务接口定义方：JDK 自带的<code>java.sql.Driver</code></p></li><li><p>spi 服务实现提供方：各大数据库厂商，如 <code>mysql-connector-j-9.4.0.jar</code></p></li><li><p>服务使用方：JDK 自带的 <code>DriverManager</code></p><ul><li>正是因为 <strong>spi 服务接口定义方</strong> 与 <strong>服务使用方</strong> 是 JDK 自带的，因此仅需引入第三方数据库驱动 jar 包即可获取对应的Driver执行数据库操作；</li><li>但同时也因为 <strong>spi 服务接口定义方</strong> 与 <strong>服务使用方</strong> 是 JDK 自带的，而其位置在 rt.jar (JDK8)中，根据双亲委派机制 <code>DriverManager</code>由启动类加载器加载，而启动类加载器无法加载 classpath 下的第三方 jar 包的 Driver 实现，因此只能委派线程上下文类加载器去加载，因此被认为打破了双亲委派机制。</li><li>因此仅需引入第三方driver jar包，在编写以下几行代码即可轻松实现：</li></ul><div class="language-java" data-highlighter="shiki" data-ext="java" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> static</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> throws SQLException </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        String</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">jdbc:mysql://localhost:3306/esign-low-code-framework?useSSL=false&amp;serverTimezone=UTC</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //1. 获取连接</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            Connection</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> connection</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> DriverManager</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getConnection</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">root</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">123456</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //2. 获取Statement</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            Statement</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> statement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> connection</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">createStatement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //3. 执行查询</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            ResultSet</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> resultSet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> statement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">executeQuery</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">SELECT * from sys_user limit 10</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        )</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            //4. 结果处理</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">resultSet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">())</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                System</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">out</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">name: %s, account: %s</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">                        resultSet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getString</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">name</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">),</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">resultSet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getString</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                );</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span></code></pre></div></li></ul></details><p>(3) <strong>OSGI框架</strong></p><p>用的不多，暂不介绍。</p><h3 id="_5-jdk9之后的变化" tabindex="-1"><a class="header-anchor" href="#_5-jdk9之后的变化"><span>5. JDK9之后的变化</span></a></h3><p>引入了模块化机制：</p><ul><li>通过 <code>-module-path</code> 参数指定模块路径；可在module-info.java文件声明模块导入导出与指定SPI机制的实现类；</li><li>如果不通过<code>-module-path</code>参数使用模块化机制，类加载器的行为与SPI机制完全兼容JDK8。</li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>尽管引入了模块化机制，但是使用的场景很少，因为用maven、gradle构建工具就可以实现大部分功能了，且大部分框架并没有提供模块化的包，如Spring、Mybatis等（可能未来某一年会有）。</p></div>`,7))])}const j=r(D,[["render",x]]),L=JSON.parse('{"path":"/java/jvm/nqycs5st/","title":"类加载器","lang":"zh-CN","frontmatter":{"title":"类加载器","createTime":"2025/10/14 21:27:29","permalink":"/java/jvm/nqycs5st/","outline":"deep"},"readingTime":{"minutes":11.72,"words":3516},"git":{"updatedTime":1763893415000,"contributors":[{"name":"csx","username":"csx","email":"2926027318@qq.com","commits":9,"avatar":"https://avatars.githubusercontent.com/csx?v=4","url":"https://github.com/csx"}]},"filePathRelative":"notes/java/jvm/ClassLoader/index.md","headers":[]}');export{j as comp,L as data};
